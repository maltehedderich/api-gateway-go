apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: default
  labels:
    app: api-gateway
    component: gateway
data:
  # Redis configuration
  redis_addr: "redis-master.default.svc.cluster.local:6379"
  redis_db: "0"
  redis_pool_size: "10"

  # Configuration file (base config)
  config.yaml: |
    server:
      http_port: 8080
      https_port: 8443
      metrics_port: 9090
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 120s
      shutdown_timeout: 30s
      max_header_bytes: 1048576

    logging:
      level: info
      format: json
      output: stdout
      sanitize_headers:
        - Authorization
        - Cookie
        - X-API-Key
      sanitize_query_params:
        - token
        - password
        - secret
        - api_key

    auth:
      session_cookie_name: session_token
      jwt:
        algorithm: RS256
        public_key_path: /app/secrets/jwt-public-key.pem
        clock_skew: 30s
        required_claims:
          - sub
          - exp
          - iat
      cache_ttl: 5m
      revocation_list:
        enabled: true
        redis_key_prefix: "revoked:"
        check_interval: 10s

    ratelimit:
      enabled: true
      storage: redis
      failure_mode: fail_closed
      default_limit:
        requests: 1000
        window: 1m
        burst: 100
      routes:
        - path: /api/v1/search
          requests: 100
          window: 1m
          burst: 20
        - path: /api/v1/orders
          requests: 500
          window: 1h
          burst: 50
        - path: /_health/*
          requests: 0  # unlimited
          window: 1m

    redis:
      addr: ${GATEWAY_REDIS_ADDR}
      password: ""
      db: 0
      pool_size: 10
      min_idle_conns: 5
      max_retries: 3
      dial_timeout: 5s
      read_timeout: 3s
      write_timeout: 3s

    routes:
      - path: /api/v1/users
        methods: [GET, POST, PUT, DELETE]
        backend: http://user-service.default.svc.cluster.local:8080
        timeout: 30s
        auth_policy: authenticated
        strip_path: false

      - path: /api/v1/orders
        methods: [GET, POST, PUT, DELETE]
        backend: http://order-service.default.svc.cluster.local:8080
        timeout: 30s
        auth_policy: authenticated
        strip_path: false

      - path: /api/v1/products
        methods: [GET]
        backend: http://product-service.default.svc.cluster.local:8080
        timeout: 30s
        auth_policy: public
        strip_path: false

      - path: /_health/live
        methods: [GET]
        auth_policy: public
        internal: true

      - path: /_health/ready
        methods: [GET]
        auth_policy: public
        internal: true

    metrics:
      enabled: true
      path: /metrics
      port: 9090

    tracing:
      enabled: true
      sample_rate: 0.1
      propagate_headers:
        - X-Correlation-ID
        - traceparent
        - tracestate

    security:
      tls:
        enabled: true
        cert_file: /app/secrets/tls.crt
        key_file: /app/secrets/tls.key
        min_version: "1.2"
        cipher_suites:
          - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
          - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
          - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
          - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
          - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      headers:
        strict_transport_security: "max-age=31536000; includeSubDomains; preload"
        x_content_type_options: "nosniff"
        x_frame_options: "DENY"
        x_xss_protection: "1; mode=block"
        content_security_policy: "default-src 'self'"
      cors:
        enabled: false
        allowed_origins: []
        allowed_methods: [GET, POST, PUT, DELETE, OPTIONS]
        allowed_headers: [Authorization, Content-Type, X-Correlation-ID]
        max_age: 86400
