# Production Configuration
# This configuration is optimized for production with strict security

server:
  http_port: 8080
  https_port: 8443
  tls_enabled: true
  tls_cert_file: /etc/gateway/certs/tls.crt
  tls_key_file: /etc/gateway/certs/tls.key
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s
  handler_timeout: 30s
  max_header_bytes: 1048576  # 1 MB
  shutdown_timeout: 30s
  enable_http2: true
  trusted_proxies:
    - 10.0.0.0/8

logging:
  level: warn  # Only log warnings and errors in production
  format: json
  output: stdout
  sanitize_patterns:
    - "(?i)password"
    - "(?i)token"
    - "(?i)secret"
    - "(?i)api[_-]?key"
    - "(?i)authorization"
    - "(?i)cookie"
    - "(?i)bearer"
  component_levels:
    http: info  # Keep HTTP logs at info level for debugging
  enable_sampling: true
  sampling_rate: 0.1  # Sample 10% of high-volume endpoints

authorization:
  enabled: true
  cookie_name: session_token
  jwt_signing_algorithm: RS256
  jwt_public_key_file: /etc/gateway/keys/public.pem
  clock_skew_tolerance: 5s
  required_claims:
    - sub
    - exp
    - iat
    - iss
    - aud
  revocation_list_url: http://auth-service.internal:8080/api/v1/revocations
  revocation_list_cache: 10s  # Shorter cache in production
  cache_auth_decisions: true
  cache_decision_ttl: 2m  # Shorter TTL for fresher permissions

rate_limit:
  enabled: true
  backend: redis
  redis_addr: redis-cluster:6379
  redis_password: ""  # Set via environment variable
  redis_db: 0
  failure_mode: fail-closed  # Fail closed in production for protection
  global_limits:
    - key: ip
      limit: 500
      window: 1m
      burst: 50

routes:
  - path_pattern: /api/v1/users
    methods:
      - GET
      - POST
    backend_url: http://user-service.internal:8080
    timeout: 10s
    auth_policy: authenticated
    rate_limits:
      - key: user
        limit: 60
        window: 1m
        burst: 10

  - path_pattern: /api/v1/users/{id}
    methods:
      - GET
      - PUT
      - DELETE
    backend_url: http://user-service.internal:8080
    timeout: 10s
    auth_policy: authenticated
    rate_limits:
      - key: user
        limit: 60
        window: 1m
        burst: 10

  - path_pattern: /api/v1/orders
    methods:
      - GET
      - POST
    backend_url: http://order-service.internal:8080
    timeout: 15s
    auth_policy: authenticated
    rate_limits:
      - key: user
        limit: 30
        window: 1m
        burst: 5

  - path_pattern: /api/v1/orders/{id}
    methods:
      - GET
      - PUT
      - DELETE
    backend_url: http://order-service.internal:8080
    timeout: 15s
    auth_policy: authenticated
    rate_limits:
      - key: user
        limit: 30
        window: 1m
        burst: 5

  - path_pattern: /api/v1/admin
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    backend_url: http://admin-service.internal:8080
    timeout: 30s
    auth_policy: role-based
    required_roles:
      - admin
    rate_limits:
      - key: user
        limit: 100
        window: 1m
        burst: 20

  - path_pattern: /api/v1/public/health
    methods:
      - GET
    backend_url: http://status-service.internal:8080
    timeout: 5s
    auth_policy: public
    rate_limits:
      - key: ip
        limit: 10
        window: 1m
        burst: 5

observability:
  metrics_enabled: true
  metrics_port: 9090
  metrics_path: /metrics
  health_path: /_health
  readiness_path: /_health/ready
  liveness_path: /_health/live
  tracing_enabled: true
  tracing_endpoint: http://jaeger-collector.observability:14268/api/traces
